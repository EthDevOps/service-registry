@model QuokkaServiceRegistry.Models.CatalogService

@{
    ViewData["Title"] = "Service Details";
}

@functions {
    string GetDataCategoryLabel(DataCategory category)
    {
        return category switch
        {
            DataCategory.PersonalData => "Personal Data",
            DataCategory.ConfidentialInformation => "Confidential Information",
            DataCategory.SensitiveData => "Sensitive Data",
            DataCategory.PublicData => "Public Data",
            _ => category.ToString()
        };
    }

    string GetProcessingPurposeLabel(ProcessingPurpose purpose)
    {
        return purpose switch
        {
            ProcessingPurpose.HumanResources => "Human Resources",
            ProcessingPurpose.Payroll => "Payroll",
            ProcessingPurpose.Authentication => "Authentication",
            ProcessingPurpose.Communication => "Communication",
            ProcessingPurpose.ProjectManagement => "Project Management",
            ProcessingPurpose.CustomerSupport => "Customer Support",
            ProcessingPurpose.Marketing => "Marketing",
            ProcessingPurpose.Analytics => "Analytics",
            ProcessingPurpose.Compliance => "Compliance",
            ProcessingPurpose.BackupAndRecovery => "Backup and Recovery",
            ProcessingPurpose.SystemAdministration => "System Administration",
            _ => purpose.ToString()
        };
    }

    string GetProcessingFrequencyLabel(ProcessingFrequency frequency)
    {
        return frequency switch
        {
            ProcessingFrequency.Continuous => "Continuous",
            ProcessingFrequency.Daily => "Daily",
            ProcessingFrequency.Weekly => "Weekly",
            ProcessingFrequency.Monthly => "Monthly",
            ProcessingFrequency.Quarterly => "Quarterly",
            ProcessingFrequency.Annually => "Annually",
            ProcessingFrequency.AdHoc => "Ad Hoc",
            ProcessingFrequency.OnDemand => "On Demand",
            _ => frequency.ToString()
        };
    }

    string GetSecurityMeasureLabel(SecurityMeasure measure)
    {
        return measure switch
        {
            SecurityMeasure.Encryption => "Encryption",
            SecurityMeasure.AccessControl => "Access Control",
            SecurityMeasure.TwoFactorAuthentication => "Two-Factor Authentication",
            SecurityMeasure.SingleSignOn => "Single Sign-On",
            SecurityMeasure.DataBackup => "Data Backup",
            SecurityMeasure.AuditLogging => "Audit Logging",
            SecurityMeasure.NetworkSecurity => "Network Security",
            SecurityMeasure.DataMinimization => "Data Minimization",
            SecurityMeasure.Pseudonymization => "Pseudonymization",
            SecurityMeasure.Anonymization => "Anonymization",
            _ => measure.ToString()
        };
    }

    string GetHostingTypeLabel(CatalogHostingType hostingType)
    {
        return hostingType switch
        {
            CatalogHostingType.SaaS => "Software as a Service (SaaS)",
            CatalogHostingType.SelfHosted => "Self-Hosted",
            _ => hostingType.ToString()
        };
    }

    string GetLifecycleStageLabel(ServiceLifecycleStageType? stageType)
    {
        if (!stageType.HasValue) return "Unknown";
        
        return stageType.Value switch
        {
            ServiceLifecycleStageType.ProofOfConcept => "Proof of Concept",
            ServiceLifecycleStageType.OrganizationWideTrial => "Organization-Wide Trial",
            ServiceLifecycleStageType.Production => "Production",
            ServiceLifecycleStageType.Deprecated => "Deprecated",
            ServiceLifecycleStageType.Decommissioned => "Decommissioned",
            _ => stageType.ToString()
        };
    }

    string GetLifecycleStageStatusLabel(ServiceLifecycleStageStatus status)
    {
        return status switch
        {
            ServiceLifecycleStageStatus.InProgress => "In Progress",
            ServiceLifecycleStageStatus.Completed => "Completed",
            ServiceLifecycleStageStatus.Cancelled => "Cancelled",
            ServiceLifecycleStageStatus.OnHold => "On Hold",
            _ => status.ToString()
        };
    }
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>@ViewData["Title"] - @Model.Name</h1>
                <div>
                    <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-primary">
                        <i class="fas fa-edit"></i> Edit
                    </a>
                    <a asp-action="Index" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to List
                    </a>
                </div>
            </div>

            @if (TempData["Success"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle"></i> @TempData["Success"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }
            
            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle"></i> @TempData["Error"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }

            <div class="row">
                <!-- Main Information -->
                <div class="col-lg-8">
                    <!-- Basic Information -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-info-circle"></i> Basic Information
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <dl class="row">
                                        <dt class="col-sm-4">Service Name:</dt>
                                        <dd class="col-sm-8"><strong>@Model.Name</strong></dd>
                                        
                                        <dt class="col-sm-4">Service Type:</dt>
                                        <dd class="col-sm-8">
                                            @if (Model.IsPropriety)
                                            {
                                                <span class="badge bg-warning">Proprietary</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-success">Open Source</span>
                                            }
                                        </dd>
                                        
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Vendor Information -->
                    @if (Model.Vendor != null)
                    {
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-building"></i> Vendor Information
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <dl class="row">
                                            <dt class="col-sm-4">Vendor Name:</dt>
                                            <dd class="col-sm-8">@Model.Vendor.Name</dd>
                                            
                                            <dt class="col-sm-4">Website:</dt>
                                            <dd class="col-sm-8">
                                                <a href="@Model.Vendor.WebsiteUrl" target="_blank" class="btn btn-outline-primary btn-sm">
                                                    <i class="fas fa-external-link-alt"></i> Visit Website
                                                </a>
                                            </dd>
                                            
                                            @if (!string.IsNullOrEmpty(Model.Vendor.Country) || !string.IsNullOrEmpty(Model.Vendor.City))
                                            {
                                                <dt class="col-sm-4">Location:</dt>
                                                <dd class="col-sm-8">@Model.Vendor.City, @Model.Vendor.Country</dd>
                                            }
                                            
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- License Information -->
                    @if (Model.License != null)
                    {
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-certificate"></i> License Information
                                </h5>
                            </div>
                            <div class="card-body">
                                <dl class="row">
                                    <dt class="col-sm-3">License Name:</dt>
                                    <dd class="col-sm-9">
                                        <span class="badge bg-info me-2">@Model.License.Abbreviation</span>
                                        @Model.License.Name
                                    </dd>
                                    
                                    <dt class="col-sm-3">License URL:</dt>
                                    <dd class="col-sm-9">
                                        <a href="@Model.License.LicenseUrl" target="_blank" class="btn btn-outline-secondary btn-sm">
                                            <i class="fas fa-external-link-alt"></i> View License
                                        </a>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    }

                    <!-- Hosting Information -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-server"></i> Hosting Information
                            </h5>
                        </div>
                        <div class="card-body">
                            <dl class="row">
                                <dt class="col-sm-3">Hosting Type:</dt>
                                <dd class="col-sm-9">
                                    <span class="badge @(Model.HostingType == CatalogHostingType.SaaS ? "bg-success" : "bg-warning")">
                                        @GetHostingTypeLabel(Model.HostingType)
                                    </span>
                                </dd>
                                
                                <dt class="col-sm-3">Hosting Country:</dt>
                                <dd class="col-sm-9">@Model.HostingCountry</dd>
                                
                                @if (!string.IsNullOrEmpty(Model.SaasRegionReference))
                                {
                                    <dt class="col-sm-3">SaaS Region:</dt>
                                    <dd class="col-sm-9">@Model.SaasRegionReference</dd>
                                }
                            </dl>
                            
                            @if (Model.OnpremiseHosts != null && Model.OnpremiseHosts.Any())
                            {
                                <h6 class="mt-3">On-Premise Hosts</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Cloud Provider</th>
                                                <th>Region</th>
                                                <th>Netbox Reference</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var host in Model.OnpremiseHosts)
                                            {
                                                <tr>
                                                    <td>@host.CloudProvider?.Name</td>
                                                    <td>@host.Region</td>
                                                    <td>
                                                        <a href="@host.NetboxReferenceUrl" target="_blank" class="btn btn-outline-info btn-sm">
                                                            <i class="fas fa-external-link-alt"></i> View
                                                        </a>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Subscription Information -->
                    @if (Model.Subscription != null)
                    {
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-credit-card"></i> Subscription Information
                                </h5>
                            </div>
                            <div class="card-body">
                                <dl class="row">
                                    <dt class="col-sm-3">Subscription:</dt>
                                    <dd class="col-sm-9">@Model.Subscription.Name</dd>
                                    
                                    <dt class="col-sm-3">Seats:</dt>
                                    <dd class="col-sm-9">
                                        <div class="progress" style="height: 20px;">
                                            @{
                                                var usagePercentage = Model.Subscription.SeatsAvailable > 0 
                                                    ? (double)Model.Subscription.SeatsUsed / Model.Subscription.SeatsAvailable * 100 
                                                    : 0;
                                                var progressClass = usagePercentage < 70 ? "bg-success" : usagePercentage < 90 ? "bg-warning" : "bg-danger";
                                            }
                                            <div class="progress-bar @progressClass" role="progressbar" 
                                                 style="width: @usagePercentage%" 
                                                 aria-valuenow="@Model.Subscription.SeatsUsed" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="@Model.Subscription.SeatsAvailable">
                                                @Model.Subscription.SeatsUsed / @Model.Subscription.SeatsAvailable seats
                                            </div>
                                        </div>
                                    </dd>
                                    
                                    <dt class="col-sm-3">Cost per Seat:</dt>
                                    <dd class="col-sm-9">$@Model.Subscription.CostPerSeatUsd USD</dd>
                                    
                                    <dt class="col-sm-3">Term Duration:</dt>
                                    <dd class="col-sm-9">@Model.Subscription.TermDuration.Days days</dd>
                                    
                                    <dt class="col-sm-3">Total Cost:</dt>
                                    <dd class="col-sm-9">
                                        <strong>$@(Model.Subscription.SeatsUsed * Model.Subscription.CostPerSeatUsd) USD</strong>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    }

                    <!-- GDPR Compliance -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-shield-alt"></i> GDPR Compliance
                            </h5>
                            <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#gdprModal">
                                <i class="fas fa-shield-alt"></i> @(Model.GdprRegister != null ? "Update" : "Set") GDPR
                            </button>
                        </div>
                        <div class="card-body">
                            @if (Model.GdprRegister != null)
                            {
                                <!-- Overview Section -->
                                <div class="row mb-4">
                                    <div class="col-md-8">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="fas fa-check-circle text-success me-2"></i>
                                            <span class="fw-bold">GDPR Compliance Configured</span>
                                        </div>
                                        @if (Model.GdprRegister.LastGdprAssessment.HasValue)
                                        {
                                            <small class="text-muted">
                                                <i class="fas fa-clock"></i> Last Assessment: @Model.GdprRegister.LastGdprAssessment.Value.ToString("MMM dd, yyyy")
                                            </small>
                                        }
                                    </div>
                                    <div class="col-md-4 text-end">
                                        @if (Model.GdprRegister.HasProcessingAgreement)
                                        {
                                            <span class="badge bg-success">
                                                <i class="fas fa-file-contract"></i> Article 28 Agreement
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-warning">
                                                <i class="fas fa-exclamation-triangle"></i> Agreement Missing
                                            </span>
                                        }
                                    </div>
                                </div>

                                <!-- Data Processing Information -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <h6 class="text-muted mb-3">
                                            <i class="fas fa-database me-1"></i> Data Processing
                                        </h6>
                                        
                                        <div class="mb-3">
                                            <small class="text-muted d-block">Data Categories</small>
                                            @if (Model.GdprRegister.DataCategories.Any())
                                            {
                                                <div class="mt-1">
                                                    @foreach (var category in Model.GdprRegister.DataCategories)
                                                    {
                                                        <span class="badge bg-info me-1 mb-1">@GetDataCategoryLabel(category)</span>
                                                    }
                                                </div>
                                            }
                                            else
                                            {
                                                <span class="text-muted">Not specified</span>
                                            }
                                        </div>
                                        
                                        <div class="mb-3">
                                            <small class="text-muted d-block">Processing Purposes</small>
                                            @if (Model.GdprRegister.ProcessingPurposes.Any())
                                            {
                                                <div class="mt-1">
                                                    @foreach (var purpose in Model.GdprRegister.ProcessingPurposes.Take(3))
                                                    {
                                                        <span class="badge bg-primary me-1 mb-1">@GetProcessingPurposeLabel(purpose)</span>
                                                    }
                                                    @if (Model.GdprRegister.ProcessingPurposes.Count > 3)
                                                    {
                                                        <span class="badge bg-light text-dark">+@(Model.GdprRegister.ProcessingPurposes.Count - 3) more</span>
                                                    }
                                                </div>
                                            }
                                            else
                                            {
                                                <span class="text-muted">Not specified</span>
                                            }
                                        </div>
                                        
                                        <div class="mb-3">
                                            <small class="text-muted d-block">Processing Frequency</small>
                                            <span class="badge bg-warning">@GetProcessingFrequencyLabel(Model.GdprRegister.ProcessingFrequency)</span>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <h6 class="text-muted mb-3">
                                            <i class="fas fa-user-shield me-1"></i> Personal Data
                                        </h6>
                                        
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <small class="text-muted">Employee PII</small>
                                                <span class="badge @(Model.GdprRegister.ProcessesEmployeePii ? "bg-warning" : "bg-success")">
                                                    @(Model.GdprRegister.ProcessesEmployeePii ? "Yes" : "No")
                                                </span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <small class="text-muted">External User PII</small>
                                                <span class="badge @(Model.GdprRegister.ProcessesExternalUserPii ? "bg-warning" : "bg-success")">
                                                    @(Model.GdprRegister.ProcessesExternalUserPii ? "Yes" : "No")
                                                </span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <small class="text-muted">Sensitive Data</small>
                                                <span class="badge @(Model.GdprRegister.ProcessesSensitiveData ? "bg-danger" : "bg-success")">
                                                    @(Model.GdprRegister.ProcessesSensitiveData ? "Yes" : "No")
                                                </span>
                                            </div>
                                        </div>
                                        
                                        @if (Model.GdprRegister.ProcessesSensitiveData && Model.GdprRegister.SensitiveDataTypes.Any())
                                        {
                                            <div class="mb-3">
                                                <small class="text-muted d-block">Sensitive Data Types</small>
                                                <div class="mt-1">
                                                    @foreach (var dataType in Model.GdprRegister.SensitiveDataTypes.Take(2))
                                                    {
                                                        <span class="badge bg-danger me-1 mb-1">@dataType</span>
                                                    }
                                                    @if (Model.GdprRegister.SensitiveDataTypes.Count > 2)
                                                    {
                                                        <span class="badge bg-light text-dark">+@(Model.GdprRegister.SensitiveDataTypes.Count - 2) more</span>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>

                                <!-- Compliance & Security -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <h6 class="text-muted mb-3">
                                            <i class="fas fa-shield-alt me-1"></i> Security Measures
                                        </h6>
                                        
                                        @if (Model.GdprRegister.SecurityMeasures.Any())
                                        {
                                            <div class="mb-3">
                                                @foreach (var measure in Model.GdprRegister.SecurityMeasures.Take(4))
                                                {
                                                    <span class="badge bg-secondary me-1 mb-1">@GetSecurityMeasureLabel(measure)</span>
                                                }
                                                @if (Model.GdprRegister.SecurityMeasures.Count > 4)
                                                {
                                                    <span class="badge bg-light text-dark">+@(Model.GdprRegister.SecurityMeasures.Count - 4) more</span>
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="text-muted">Not specified</span>
                                        }
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <h6 class="text-muted mb-3">
                                            <i class="fas fa-balance-scale me-1"></i> Data Subject Rights
                                        </h6>
                                        
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <small class="text-muted">Data Portability</small>
                                                <span class="badge @(Model.GdprRegister.SupportsDataPortability ? "bg-success" : "bg-secondary")">
                                                    @(Model.GdprRegister.SupportsDataPortability ? "Supported" : "Not Supported")
                                                </span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <small class="text-muted">Data Deletion</small>
                                                <span class="badge @(Model.GdprRegister.SupportsDataDeletion ? "bg-success" : "bg-secondary")">
                                                    @(Model.GdprRegister.SupportsDataDeletion ? "Supported" : "Not Supported")
                                                </span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <small class="text-muted">Data Correction</small>
                                                <span class="badge @(Model.GdprRegister.SupportsDataCorrection ? "bg-success" : "bg-secondary")">
                                                    @(Model.GdprRegister.SupportsDataCorrection ? "Supported" : "Not Supported")
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Stakeholders & Agreements -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-muted mb-3">
                                            <i class="fas fa-users me-1"></i> Stakeholders
                                        </h6>
                                        
                                        @if (Model.GdprRegister.Controller != null)
                                        {
                                            <div class="mb-2">
                                                <small class="text-muted d-block">Data Controller</small>
                                                <span class="fw-bold">@Model.GdprRegister.Controller.Name</span>
                                                @if (!string.IsNullOrEmpty(Model.GdprRegister.Controller.Email))
                                                {
                                                    <br><small class="text-muted">@Model.GdprRegister.Controller.Email</small>
                                                }
                                            </div>
                                        }
                                        
                                        @if (Model.GdprRegister.DpoOrganisation != null)
                                        {
                                            <div class="mb-2">
                                                <small class="text-muted d-block">DPO Organisation</small>
                                                <span class="fw-bold">@Model.GdprRegister.DpoOrganisation.Name</span>
                                                @if (!string.IsNullOrEmpty(Model.GdprRegister.DpoOrganisation.Email))
                                                {
                                                    <br><small class="text-muted">@Model.GdprRegister.DpoOrganisation.Email</small>
                                                }
                                            </div>
                                        }
                                        
                                        @if (!string.IsNullOrEmpty(Model.GdprRegister.DataProtectionOfficerContact))
                                        {
                                            <div class="mb-2">
                                                <small class="text-muted d-block">DPO Contact</small>
                                                <span>@Model.GdprRegister.DataProtectionOfficerContact</span>
                                            </div>
                                        }
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <h6 class="text-muted mb-3">
                                            <i class="fas fa-file-contract me-1"></i> Data Retention
                                        </h6>
                                        
                                        @if (Model.GdprRegister.DataRetentionPeriod.HasValue)
                                        {
                                            <div class="mb-2">
                                                <small class="text-muted d-block">Retention Period</small>
                                                <span class="badge bg-info">@Model.GdprRegister.DataRetentionPeriod.Value.Days days</span>
                                            </div>
                                        }
                                        
                                        @if (!string.IsNullOrEmpty(Model.GdprRegister.DataDeletionProcess))
                                        {
                                            <div class="mb-2">
                                                <small class="text-muted d-block">Deletion Process</small>
                                                <span class="small">@Model.GdprRegister.DataDeletionProcess</span>
                                            </div>
                                        }
                                        
                                        @if (Model.GdprRegister.ProcessingAgreementDate.HasValue)
                                        {
                                            <div class="mb-2">
                                                <small class="text-muted d-block">Agreement Date</small>
                                                <span>@Model.GdprRegister.ProcessingAgreementDate.Value.ToString("MMM dd, yyyy")</span>
                                            </div>
                                        }
                                    </div>
                                </div>

                                @if (!string.IsNullOrEmpty(Model.GdprRegister.ComplianceNotes))
                                {
                                    <div class="mt-3 pt-3 border-top">
                                        <h6 class="text-muted mb-2">
                                            <i class="fas fa-sticky-note me-1"></i> Compliance Notes
                                        </h6>
                                        <p class="small text-muted mb-0">@Model.GdprRegister.ComplianceNotes</p>
                                    </div>
                                }
                            }
                            else
                            {
                                <p class="text-muted mb-0">
                                    <i class="fas fa-info-circle"></i> No GDPR compliance information recorded. 
                                    Click "Set GDPR" to configure compliance settings.
                                </p>
                            }
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="col-lg-4">
                    <!-- Quick Stats -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-chart-pie"></i> Quick Stats
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <small class="text-muted">Current Lifecycle Stage</small><br>
                                <span class="badge bg-primary">@GetLifecycleStageLabel(Model.Lifecycle?.CurrentStage)</span>
                            </div>
                            
                            @if (Model.Subscription != null)
                            {
                                <div class="mb-3">
                                    <small class="text-muted">Seat Utilization</small><br>
                                    @{
                                        var utilization = Model.Subscription.SeatsAvailable > 0 
                                            ? (double)Model.Subscription.SeatsUsed / Model.Subscription.SeatsAvailable * 100 
                                            : 0;
                                    }
                                    <strong>@utilization.ToString("F1")%</strong>
                                </div>
                            }
                            
                            <div class="mb-3">
                                <small class="text-muted">Hosting Location</small><br>
                                <span class="badge @(Model.HostingType == CatalogHostingType.SaaS ? "bg-success" : "bg-warning")">
                                    @GetHostingTypeLabel(Model.HostingType)
                                </span>
                                <br>
                                <small class="text-muted mt-1">
                                    <i class="fas fa-globe"></i> @Model.HostingCountry
                                </small>
                            </div>
                            
                            <div class="mb-3">
                                <small class="text-muted">GDPR Compliance</small><br>
                                @if (Model.GdprRegister != null)
                                {
                                    <span class="badge bg-success">Registered</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">Not Required</span>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Lifecycle Information -->
                    @if (Model.Lifecycle != null)
                    {
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-project-diagram"></i> Lifecycle Stages
                                </h5>
                                <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addStageModal">
                                    <i class="fas fa-plus"></i> Add Stage
                                </button>
                            </div>
                            <div class="card-body">
                                @if (Model.Lifecycle.Stages != null && Model.Lifecycle.Stages.Any())
                                {
                                    @foreach (var stage in Model.Lifecycle.Stages.OrderBy(s => s.StartDate))
                                    {
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="badge @(stage.Status == ServiceLifecycleStageStatus.Completed ? "bg-success" : stage.Status == ServiceLifecycleStageStatus.InProgress ? "bg-primary" : "bg-secondary")">
                                                    @GetLifecycleStageLabel(stage.StageType)
                                                </span>
                                                <small class="text-muted">@GetLifecycleStageStatusLabel(stage.Status)</small>
                                            </div>
                                            @if (stage.StartDate.HasValue)
                                            {
                                                <small class="text-muted">Started: @stage.StartDate.Value.ToString("yyyy-MM-dd")</small>
                                            }
                                            @if (stage.EndDate.HasValue)
                                            {
                                                <br><small class="text-muted">Completed: @stage.EndDate.Value.ToString("yyyy-MM-dd")</small>
                                            }
                                            @if (!string.IsNullOrEmpty(stage.Sponsor))
                                            {
                                                <br><small class="text-muted">Sponsor: @stage.Sponsor</small>
                                            }
                                        </div>
                                    }
                                }
                                else
                                {
                                    <p class="text-muted">No lifecycle stages recorded yet.</p>
                                }
                            </div>
                        </div>
                    }

                    <!-- GDPR Compliance Summary -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-shield-alt"></i> GDPR Compliance
                            </h6>
                            <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#gdprModal">
                                <i class="fas fa-edit"></i> @(Model.GdprRegister != null ? "Update" : "Set")
                            </button>
                        </div>
                        <div class="card-body">
                            @if (Model.GdprRegister != null)
                            {
                                <div class="mb-3">
                                    <small class="text-muted">GDPR Compliance</small><br>
                                    @if (Model.GdprRegister.HasProcessingAgreement)
                                    {
                                        <span class="badge bg-success">
                                            <i class="fas fa-check-circle"></i> Configured
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning">
                                            <i class="fas fa-exclamation-triangle"></i> Incomplete
                                        </span>
                                    }
                                </div>

                                <div class="mb-3">
                                    <small class="text-muted">Personal Data Processing</small><br>
                                    @if (Model.GdprRegister.ProcessesEmployeePii || Model.GdprRegister.ProcessesExternalUserPii)
                                    {
                                        <span class="badge bg-warning">
                                            <i class="fas fa-user-shield"></i> Processes PII
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success">
                                            <i class="fas fa-check"></i> No PII
                                        </span>
                                    }
                                </div>

                                @if (Model.GdprRegister.LastGdprAssessment.HasValue)
                                {
                                    <div class="mb-0">
                                        <small class="text-muted">Last Assessment</small><br>
                                        <small>@Model.GdprRegister.LastGdprAssessment.Value.ToString("MMM dd, yyyy")</small>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="text-center">
                                    <i class="fas fa-info-circle text-muted mb-2" style="font-size: 2rem;"></i>
                                    <p class="text-muted mb-0 small">
                                        No GDPR compliance information configured.
                                    </p>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-cogs"></i> Actions
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-primary">
                                    <i class="fas fa-edit"></i> Edit Service
                                </a>
                                <a asp-action="Delete" asp-route-id="@Model.Id" class="btn btn-outline-danger">
                                    <i class="fas fa-trash"></i> Delete Service
                                </a>
                                <hr>
                                <button type="button" class="btn btn-outline-info" onclick="exportService()">
                                    <i class="fas fa-download"></i> Export Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Lifecycle Stage Modal -->
<div class="modal fade" id="addStageModal" tabindex="-1" aria-labelledby="addStageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="AddLifecycleStage" method="post">
                <input type="hidden" name="serviceId" value="@Model.Id" />
                <div class="modal-header">
                    <h5 class="modal-title" id="addStageModalLabel">Add New Lifecycle Stage</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="stageType" class="form-label">Stage Type <span class="text-danger">*</span></label>
                        <select name="stageType" class="form-select" required>
                            <option value="">-- Select Stage --</option>
                            @foreach (var stageType in Enum.GetValues<ServiceLifecycleStageType>())
                            {
                                @if (Model.Lifecycle?.Stages?.Any(s => s.StageType == stageType) != true)
                                {
                                    <option value="@stageType">@GetLifecycleStageLabel(stageType)</option>
                                }
                            }
                        </select>
                        <div class="form-text">Select the next stage in the service lifecycle.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="sponsor" class="form-label">Sponsor (Optional)</label>
                        <input type="text" name="sponsor" class="form-control" placeholder="e.g., John Doe, IT Department">
                        <div class="form-text">Person or department sponsoring this stage.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes (Optional)</label>
                        <textarea name="notes" class="form-control" rows="3" placeholder="Any additional notes about this stage..."></textarea>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Note:</strong> Adding a new stage will automatically complete the current in-progress stage and start the new one.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add Stage
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- GDPR Compliance Modal -->
<div class="modal fade" id="gdprModal" tabindex="-1" aria-labelledby="gdprModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <form asp-action="SetGdprCompliance" method="post">
                <input type="hidden" name="serviceId" value="@Model.Id" />
                <div class="modal-header bg-primary text-white">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-shield-alt me-2"></i>
                        <div>
                            <h5 class="modal-title mb-0" id="gdprModalLabel">GDPR Compliance Assessment</h5>
                            <small class="opacity-75">Article 28 Data Processing Agreement</small>
                        </div>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <!-- Progress Bar -->
                <div class="modal-header border-0 pb-0">
                    <div class="w-100">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small text-muted">Completion Progress</span>
                            <span class="small text-muted"><span id="completionPercentage">0</span>% Complete</span>
                        </div>
                        <div class="progress" style="height: 4px;">
                            <div class="progress-bar bg-success" role="progressbar" id="progressBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="modal-body p-0">
                    <!-- Navigation Tabs -->
                    <ul class="nav nav-pills nav-justified p-3 bg-light border-bottom" id="gdprTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active position-relative" id="basics-tab" data-bs-toggle="pill" data-bs-target="#basics" type="button" role="tab">
                                <i class="fas fa-info-circle me-1"></i>
                                <span class="d-none d-md-inline">Basics</span>
                                <span class="badge bg-success rounded-pill position-absolute top-0 start-100 translate-middle" id="basics-badge" style="display: none;">✓</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link position-relative" id="stakeholders-tab" data-bs-toggle="pill" data-bs-target="#stakeholders" type="button" role="tab">
                                <i class="fas fa-users me-1"></i>
                                <span class="d-none d-md-inline">Stakeholders</span>
                                <span class="badge bg-success rounded-pill position-absolute top-0 start-100 translate-middle" id="stakeholders-badge" style="display: none;">✓</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link position-relative" id="processing-tab" data-bs-toggle="pill" data-bs-target="#processing" type="button" role="tab">
                                <i class="fas fa-cogs me-1"></i>
                                <span class="d-none d-md-inline">Processing</span>
                                <span class="badge bg-success rounded-pill position-absolute top-0 start-100 translate-middle" id="processing-badge" style="display: none;">✓</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link position-relative" id="security-tab" data-bs-toggle="pill" data-bs-target="#security" type="button" role="tab">
                                <i class="fas fa-lock me-1"></i>
                                <span class="d-none d-md-inline">Security</span>
                                <span class="badge bg-success rounded-pill position-absolute top-0 start-100 translate-middle" id="security-badge" style="display: none;">✓</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link position-relative" id="rights-tab" data-bs-toggle="pill" data-bs-target="#rights" type="button" role="tab">
                                <i class="fas fa-balance-scale me-1"></i>
                                <span class="d-none d-md-inline">Rights</span>
                                <span class="badge bg-success rounded-pill position-absolute top-0 start-100 translate-middle" id="rights-badge" style="display: none;">✓</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link position-relative" id="compliance-tab" data-bs-toggle="pill" data-bs-target="#compliance" type="button" role="tab">
                                <i class="fas fa-file-contract me-1"></i>
                                <span class="d-none d-md-inline">Compliance</span>
                                <span class="badge bg-success rounded-pill position-absolute top-0 start-100 translate-middle" id="compliance-badge" style="display: none;">✓</span>
                            </button>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content p-4" id="gdprTabContent" style="max-height: 70vh; overflow-y: auto;">
                        
                        <!-- Basics Tab -->
                        <div class="tab-pane fade show active" id="basics" role="tabpanel">
                            <div class="row">
                                <div class="col-12">
                                    <div class="alert alert-info border-0">
                                        <div class="d-flex">
                                            <i class="fas fa-info-circle text-info me-3 mt-1"></i>
                                            <div>
                                                <h6 class="alert-heading mb-1">Data Classification & Processing Overview</h6>
                                                <p class="mb-0 small">Define what types of personal data this service processes and for what purposes. This forms the foundation of your GDPR compliance.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <!-- Data Categories -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Data Categories <span class="text-danger">*</span></label>
                                        <div class="border rounded p-3 bg-light">
                                            @foreach (var category in Enum.GetValues<DataCategory>())
                                            {
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="dataCategories" value="@category" id="category_@category"
                                                           @(Model.GdprRegister?.DataCategories?.Contains(category) == true ? "checked" : "") />
                                                    <label class="form-check-label" for="category_@category">@GetDataCategoryLabel(category)</label>
                                                </div>
                                            }
                                        </div>
                                    </div>

                                    <!-- Processing Purposes -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Processing Purposes <span class="text-danger">*</span></label>
                                        <div class="border rounded p-3 bg-light" style="max-height: 200px; overflow-y: auto;">
                                            @foreach (var purpose in Enum.GetValues<ProcessingPurpose>())
                                            {
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="processingPurposes" value="@purpose" id="purpose_@purpose"
                                                           @(Model.GdprRegister?.ProcessingPurposes?.Contains(purpose) == true ? "checked" : "") />
                                                    <label class="form-check-label" for="purpose_@purpose">@GetProcessingPurposeLabel(purpose)</label>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <!-- Processing Frequency -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Processing Frequency <span class="text-danger">*</span></label>
                                        <select name="processingFrequency" class="form-select" required>
                                            <option value="">-- Select Frequency --</option>
                                            @foreach (var frequency in Enum.GetValues<ProcessingFrequency>())
                                            {
                                                @if (Model.GdprRegister?.ProcessingFrequency == frequency)
                                                {
                                                    <option value="@frequency" selected>@GetProcessingFrequencyLabel(frequency)</option>
                                                }
                                                else
                                                {
                                                    <option value="@frequency">@GetProcessingFrequencyLabel(frequency)</option>
                                                }
                                            }
                                        </select>
                                    </div>

                                    <!-- PII Processing -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Personal Data Processing</label>
                                        <div class="border rounded p-3 bg-light">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="processesEmployeePii" value="true" id="employeePii"
                                                       @(Model.GdprRegister?.ProcessesEmployeePii == true ? "checked" : "") />
                                                <label class="form-check-label" for="employeePii">Processes Employee PII</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="processesExternalUserPii" value="true" id="externalPii"
                                                       @(Model.GdprRegister?.ProcessesExternalUserPii == true ? "checked" : "") />
                                                <label class="form-check-label" for="externalPii">Processes External User PII</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="processesSensitiveData" value="true" id="sensitiveData"
                                                       @(Model.GdprRegister?.ProcessesSensitiveData == true ? "checked" : "") />
                                                <label class="form-check-label" for="sensitiveData">Processes Sensitive Data</label>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Sensitive Data Types -->
                                    <div class="mb-4">
                                        <label for="sensitiveDataTypes" class="form-label fw-bold">Sensitive Data Types</label>
                                        <input type="text" name="sensitiveDataTypes" class="form-control" 
                                               value="@(Model.GdprRegister?.SensitiveDataTypes != null ? string.Join(", ", Model.GdprRegister.SensitiveDataTypes) : "")"
                                               placeholder="e.g., health data, financial data">
                                        <div class="form-text">Comma-separated list of sensitive data types.</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Stakeholders Tab -->
                        <div class="tab-pane fade" id="stakeholders" role="tabpanel">
                            <div class="row">
                                <div class="col-12">
                                    <div class="alert alert-info border-0">
                                        <div class="d-flex">
                                            <i class="fas fa-users text-info me-3 mt-1"></i>
                                            <div>
                                                <h6 class="alert-heading mb-1">Controller & DPO Information</h6>
                                                <p class="mb-0 small">Define the data controller and Data Protection Officer responsible for this service according to GDPR Article 28.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Controller Information -->
                            <div class="card border-light mb-4">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-building text-primary"></i> Controller Information
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="controllerName" class="form-label fw-bold">Controller Name <span class="text-danger">*</span></label>
                                                <input type="text" name="controllerName" class="form-control" 
                                                       value="@Model.GdprRegister?.Controller?.Name"
                                                       placeholder="e.g., Company Name" data-required="true">
                                                <div class="form-text">Name of the data controller organization.</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="controllerEmail" class="form-label fw-bold">Controller Email <span class="text-danger">*</span></label>
                                                <input type="email" name="controllerEmail" class="form-control" 
                                                       value="@Model.GdprRegister?.Controller?.Email"
                                                       placeholder="e.g., contact@company.com" data-required="true">
                                                <div class="form-text">Email contact for the controller.</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="mb-3">
                                                <label for="controllerAddress" class="form-label fw-bold">Controller Address</label>
                                                <input type="text" name="controllerAddress" class="form-control" 
                                                       value="@Model.GdprRegister?.Controller?.Address"
                                                       placeholder="e.g., 123 Main Street">
                                                <div class="form-text">Physical address of the controller.</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="controllerZipCode" class="form-label fw-bold">ZIP Code</label>
                                                <input type="text" name="controllerZipCode" class="form-control" 
                                                       value="@Model.GdprRegister?.Controller?.ZipCode"
                                                       placeholder="12345">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="controllerCity" class="form-label fw-bold">City</label>
                                                <input type="text" name="controllerCity" class="form-control" 
                                                       value="@Model.GdprRegister?.Controller?.City"
                                                       placeholder="e.g., New York">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="controllerCountry" class="form-label fw-bold">Country</label>
                                                <input type="text" name="controllerCountry" class="form-control" 
                                                       value="@Model.GdprRegister?.Controller?.Country"
                                                       placeholder="e.g., USA">
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="mb-3">
                                                <label for="controllerPhone" class="form-label fw-bold">Phone</label>
                                                <input type="tel" name="controllerPhone" class="form-control" 
                                                       value="@Model.GdprRegister?.Controller?.Phone"
                                                       placeholder="+1234567890">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- DPO Organisation Information -->
                            <div class="card border-light">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-user-shield text-info"></i> Data Protection Officer
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="form-check mb-3">
                                        <input type="checkbox" name="hasExternalDpo" class="form-check-input" id="hasExternalDpo"
                                               @(Model.GdprRegister?.DpoOrganisation != null ? "checked" : "")>
                                        <label for="hasExternalDpo" class="form-check-label fw-bold">
                                            Has External DPO Organisation
                                        </label>
                                        <div class="form-text">Check if using an external Data Protection Officer organization.</div>
                                    </div>
                                    
                                    <div id="dpoFields" style="@(Model.GdprRegister?.DpoOrganisation != null ? "" : "display: none;")">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="dpoOrganisationName" class="form-label fw-bold">DPO Organisation Name</label>
                                                    <input type="text" name="dpoOrganisationName" class="form-control" 
                                                           value="@Model.GdprRegister?.DpoOrganisation?.Name"
                                                           placeholder="e.g., DPO Services Ltd">
                                                    <div class="form-text">Name of the external DPO organization.</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="dpoOrganisationEmail" class="form-label fw-bold">DPO Organisation Email</label>
                                                    <input type="email" name="dpoOrganisationEmail" class="form-control" 
                                                           value="@Model.GdprRegister?.DpoOrganisation?.Email"
                                                           placeholder="e.g., dpo@dposervices.com">
                                                    <div class="form-text">Email contact for the DPO organization.</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Processing Tab -->
                        <div class="tab-pane fade" id="processing" role="tabpanel">
                            <div class="row">
                                <div class="col-12">
                                    <div class="alert alert-info border-0">
                                        <div class="d-flex">
                                            <i class="fas fa-cogs text-info me-3 mt-1"></i>
                                            <div>
                                                <h6 class="alert-heading mb-1">Data Processing Activities</h6>
                                                <p class="mb-0 small">Define how personal data is processed, retained, and transferred according to GDPR Article 28.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Processing Agreement -->
                            <div class="card border-light mb-4">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-file-contract text-primary"></i> Processing Agreement
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" name="hasProcessingAgreement" value="true" id="processingAgreement"
                                               @(Model.GdprRegister?.HasProcessingAgreement == true ? "checked" : "") />
                                        <label class="form-check-label fw-bold" for="processingAgreement">Has Processing Agreement</label>
                                        <div class="form-text">Article 28(3) requires a written processing agreement.</div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="processingAgreementDate" class="form-label fw-bold">Agreement Date</label>
                                                <input type="date" name="processingAgreementDate" class="form-control" 
                                                       value="@Model.GdprRegister?.ProcessingAgreementDate?.ToString("yyyy-MM-dd")">
                                                <div class="form-text">Date when the processing agreement was signed.</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="processingAgreementReference" class="form-label fw-bold">Agreement Reference</label>
                                                <input type="text" name="processingAgreementReference" class="form-control" 
                                                       value="@Model.GdprRegister?.ProcessingAgreementReference"
                                                       placeholder="e.g., Agreement #2024-001">
                                                <div class="form-text">Reference number or identifier for the agreement.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Data Retention -->
                            <div class="card border-light">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-clock text-warning"></i> Data Retention & Deletion
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="dataRetentionDays" class="form-label fw-bold">Data Retention Period</label>
                                                <div class="input-group">
                                                    <input type="number" name="dataRetentionDays" class="form-control" 
                                                           value="@(Model.GdprRegister?.DataRetentionPeriod?.Days)"
                                                           placeholder="365">
                                                    <span class="input-group-text">days</span>
                                                </div>
                                                <div class="form-text">Maximum period to retain personal data.</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="dataDeletionProcess" class="form-label fw-bold">Data Deletion Process</label>
                                                <input type="text" name="dataDeletionProcess" class="form-control" 
                                                       value="@Model.GdprRegister?.DataDeletionProcess"
                                                       placeholder="e.g., Automated deletion after retention period">
                                                <div class="form-text">Description of how data is deleted.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Security Tab -->
                        <div class="tab-pane fade" id="security" role="tabpanel">
                            <div class="row">
                                <div class="col-12">
                                    <div class="alert alert-info border-0">
                                        <div class="d-flex">
                                            <i class="fas fa-lock text-info me-3 mt-1"></i>
                                            <div>
                                                <h6 class="alert-heading mb-1">Security Measures & Safeguards</h6>
                                                <p class="mb-0 small">Document technical and organizational measures to ensure data security as required by GDPR Article 28.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Security Measures Card -->
                            <div class="card border-light">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-shield-alt text-success"></i> Security Measures
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Technical & Organizational Measures <span class="text-danger">*</span></label>
                                        <div class="border rounded p-3 bg-light" style="max-height: 300px; overflow-y: auto;">
                                            @foreach (var measure in Enum.GetValues<SecurityMeasure>())
                                            {
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="securityMeasures" value="@measure" id="measure_@measure"
                                                           @(Model.GdprRegister?.SecurityMeasures?.Contains(measure) == true ? "checked" : "") />
                                                    <label class="form-check-label" for="measure_@measure">@GetSecurityMeasureLabel(measure)</label>
                                                </div>
                                            }
                                        </div>
                                        <div class="form-text">Select all security measures implemented for this service.</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Rights Tab -->
                        <div class="tab-pane fade" id="rights" role="tabpanel">
                            <div class="row">
                                <div class="col-12">
                                    <div class="alert alert-info border-0">
                                        <div class="d-flex">
                                            <i class="fas fa-balance-scale text-info me-3 mt-1"></i>
                                            <div>
                                                <h6 class="alert-heading mb-1">Data Subject Rights</h6>
                                                <p class="mb-0 small">Configure support for data subject rights as required by GDPR Articles 15-22.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Data Subject Rights Card -->
                            <div class="card border-light">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-user-check text-primary"></i> Rights Support
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Supported Data Subject Rights</label>
                                        <div class="border rounded p-3 bg-light">
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" name="supportsDataPortability" value="true" id="dataPortability"
                                                       @(Model.GdprRegister?.SupportsDataPortability == true ? "checked" : "") />
                                                <label class="form-check-label" for="dataPortability">
                                                    <strong>Data Portability</strong> <small class="text-muted">(Article 20)</small>
                                                </label>
                                                <div class="form-text">Right to receive personal data in a structured format.</div>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" name="supportsDataDeletion" value="true" id="dataDeletion"
                                                       @(Model.GdprRegister?.SupportsDataDeletion == true ? "checked" : "") />
                                                <label class="form-check-label" for="dataDeletion">
                                                    <strong>Data Deletion</strong> <small class="text-muted">(Article 17 - Right to be Forgotten)</small>
                                                </label>
                                                <div class="form-text">Right to erasure of personal data.</div>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" name="supportsDataCorrection" value="true" id="dataCorrection"
                                                       @(Model.GdprRegister?.SupportsDataCorrection == true ? "checked" : "") />
                                                <label class="form-check-label" for="dataCorrection">
                                                    <strong>Data Correction</strong> <small class="text-muted">(Article 16 - Right to Rectification)</small>
                                                </label>
                                                <div class="form-text">Right to rectification of inaccurate personal data.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Compliance Tab -->
                        <div class="tab-pane fade" id="compliance" role="tabpanel">
                            <div class="row">
                                <div class="col-12">
                                    <div class="alert alert-info border-0">
                                        <div class="d-flex">
                                            <i class="fas fa-file-contract text-info me-3 mt-1"></i>
                                            <div>
                                                <h6 class="alert-heading mb-1">Compliance Documentation</h6>
                                                <p class="mb-0 small">Document compliance assessments, DPO contacts, and additional notes.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

            <!-- Compliance Documentation Card -->
                            <div class="card border-light mb-4">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-clipboard-check text-primary"></i> Compliance Assessment
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="dataProtectionOfficerContact" class="form-label fw-bold">DPO Contact</label>
                                                <input type="text" name="dataProtectionOfficerContact" class="form-control" 
                                                       value="@Model.GdprRegister?.DataProtectionOfficerContact"
                                                       placeholder="e.g., dpo@company.com">
                                                <div class="form-text">Contact information for the Data Protection Officer.</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="lastGdprAssessment" class="form-label fw-bold">Last GDPR Assessment</label>
                                                <input type="date" name="lastGdprAssessment" class="form-control" 
                                                       value="@Model.GdprRegister?.LastGdprAssessment?.ToString("yyyy-MM-dd")">
                                                <div class="form-text">Date of the last compliance assessment.</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="complianceNotes" class="form-label fw-bold">Compliance Notes</label>
                                        <textarea name="complianceNotes" class="form-control" rows="4" 
                                                  placeholder="Additional notes about GDPR compliance for this service...">@Model.GdprRegister?.ComplianceNotes</textarea>
                                        <div class="form-text">Additional compliance information, assessments, or notes.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div> <!-- Close compliance tab-pane -->
                    
                    <!-- Close tab-content div -->
                <div>
                    <!-- Modal Footer Information -->
                    <div class="bg-light p-3 border-top">
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-info-circle"></i>
                            <strong>Note:</strong> This assessment will be timestamped and can be updated as compliance requirements change.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-shield-alt"></i> Save GDPR Compliance
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script>
        function exportService() {
            // TODO: Implement service data export functionality
            alert('Service export functionality will be implemented in a future update.');
        }
        
        // Toggle DPO Organisation fields visibility
        document.addEventListener('DOMContentLoaded', function() {
            const hasExternalDpoCheckbox = document.getElementById('hasExternalDpo');
            const dpoFields = document.getElementById('dpoFields');
            
            if (hasExternalDpoCheckbox && dpoFields) {
                hasExternalDpoCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        dpoFields.style.display = '';
                    } else {
                        dpoFields.style.display = 'none';
                    }
                });
            }
            
            // GDPR Tab Navigation and Progress Tracking
            const tabs = document.querySelectorAll('#gdprTabs button[data-bs-toggle="pill"]');
            const progressBar = document.getElementById('progressBar');
            const completionPercentage = document.getElementById('completionPercentage');
            
            function calculateProgress() {
                let completedTabs = 0;
                const totalTabs = tabs.length;
                
                tabs.forEach(tab => {
                    const targetId = tab.getAttribute('data-bs-target').substring(1);
                    const tabContent = document.getElementById(targetId);
                    const badge = document.getElementById(targetId + '-badge');
                    
                    if (isTabComplete(tabContent)) {
                        badge.style.display = 'block';
                        completedTabs++;
                    } else {
                        badge.style.display = 'none';
                    }
                });
                
                const percentage = Math.round((completedTabs / totalTabs) * 100);
                progressBar.style.width = percentage + '%';
                completionPercentage.textContent = percentage;
            }
            
            function isTabComplete(tabContent) {
                const requiredFields = tabContent.querySelectorAll('input[data-required="true"], select[data-required="true"], input[required], select[required]');
                const checkboxGroups = tabContent.querySelectorAll('input[type="checkbox"][name$="Categories"], input[type="checkbox"][name$="Purposes"], input[type="checkbox"][name$="Measures"]');
                
                // Check required fields
                for (let field of requiredFields) {
                    if (!field.value.trim()) {
                        return false;
                    }
                }
                
                // Check if at least one checkbox is selected in each group
                const groupNames = new Set();
                checkboxGroups.forEach(checkbox => {
                    groupNames.add(checkbox.name);
                });
                
                for (let groupName of groupNames) {
                    const groupCheckboxes = tabContent.querySelectorAll(`input[type="checkbox"][name="${groupName}"]`);
                    let hasChecked = false;
                    for (let checkbox of groupCheckboxes) {
                        if (checkbox.checked) {
                            hasChecked = true;
                            break;
                        }
                    }
                    if (!hasChecked) {
                        return false;
                    }
                }
                
                return true;
            }
            
            // Add event listeners to form fields for real-time progress updates
            const gdprModal = document.getElementById('gdprModal');
            if (gdprModal) {
                const formFields = gdprModal.querySelectorAll('input, select, textarea');
                formFields.forEach(field => {
                    field.addEventListener('change', calculateProgress);
                    field.addEventListener('input', calculateProgress);
                });
                
                // Handle form submission and validation
                const gdprForm = gdprModal.querySelector('form');
                if (gdprForm) {
                    gdprForm.addEventListener('submit', function(e) {
                        // Custom validation for required fields
                        const requiredFields = gdprForm.querySelectorAll('[data-required="true"]');
                        let firstInvalidField = null;
                        
                        // Clear previous validation styles
                        requiredFields.forEach(field => {
                            field.classList.remove('is-invalid');
                            const feedback = field.parentNode.querySelector('.invalid-feedback');
                            if (feedback) feedback.remove();
                        });
                        
                        // Check required fields
                        for (let field of requiredFields) {
                            if (!field.value.trim()) {
                                field.classList.add('is-invalid');
                                const feedback = document.createElement('div');
                                feedback.className = 'invalid-feedback';
                                feedback.textContent = 'This field is required.';
                                field.parentNode.appendChild(feedback);
                                
                                if (!firstInvalidField) {
                                    firstInvalidField = field;
                                }
                            }
                        }
                        
                        // Check for validation errors
                        if (firstInvalidField) {
                            e.preventDefault();
                            
                            // Find the tab containing the invalid field and switch to it
                            const tabPane = firstInvalidField.closest('.tab-pane');
                            if (tabPane) {
                                const tabId = tabPane.id;
                                const tabButton = document.querySelector(`button[data-bs-target="#${tabId}"]`);
                                if (tabButton) {
                                    // Switch to the tab containing the invalid field
                                    const tab = new bootstrap.Tab(tabButton);
                                    tab.show();
                                    
                                    // Focus the invalid field after tab switch
                                    setTimeout(() => {
                                        firstInvalidField.focus();
                                        firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    }, 150);
                                }
                            }
                            return false;
                        }
                    });
                }
                
                // Initial progress calculation
                calculateProgress();
            }
        });
    </script>
}